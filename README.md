# MoneyForward Enhancer

マネーフォワード ME の資産推移画面から、過去の資産データを一括で取得・CSVダウンロード・グラフ表示する Google Chrome 拡張機能です。
**v1.3.0 から、家計簿画面での一括カテゴリ設定機能が追加されました。**
**v1.3.7 から、家計簿画面でのソート機能が追加されました。**
**v1.4.0 から、内部構造が大規模にリファクタリングされ、保守性が向上しました。**
**v1.5.0 から、資産推移グラフのフィルタ機能が大幅に強化されました（期間指定、月末判定など）。**
**v1.5.3 で、広くなった画面に合わせて数値ラベルの表示条件を緩和しました（過去3年分程度まで表示可能）。**
**v1.5.4 で、ポートフォリオ画面にて「保有金融機関」「取得日」「変更」「削除」の列を自動的に非表示にする機能を追加しました。**

**v1.5.5 で、ポートフォリオ分析（ヒートマップ）機能を削除しました。**
**v1.5.6 で、削除した機能に関連するバグを修正しました。**

![Version](https://img.shields.io/badge/version-1.5.6-blue.svg)

## ✨ 主な機能

### 1. 家計簿の一括カテゴリ設定 (New v1.3.0)

家計簿画面において、複数の明細を一括で編集できます。

- **一括選択**: 専用のチェックボックスで複数の行を選択。
- **カテゴリ一括適用**: 大項目・中項目を指定して、選択したすべての行に一括適用します。
- **安全な更新**: ドロップダウン操作をエミュレートし、確実に変更を保存します。
- **パネル移動**: パネルのヘッダーをドラッグすることで、画面上の好きな位置に移動できます。
- **プログレスバー表示**: 処理の進捗をバーで可視化し、完了時のポップアップを廃止しました。

### 2. 家計簿のソート機能 (New v1.3.7)

家計簿画面の表をヘッダー・クリックでソートできます。

- **日付ソート**: 日付順（昇順・降順）に並び替え。
- **金額ソート**: 金額順（昇順・降順）に並び替え。
- **内容ソート**: 内容や金融機関名で並び替え。
- **クライアントサイド処理**: 表示中のページ内で即座に並び替えます。

### 3. 家計簿・ポートフォリオ画面の表示改善 (New v1.5.4)

- **不要な列の非表示**: ポートフォリオ画面などで「保有金融機関」「取得日」などの不要な列を自動的に非表示にし、画面を広く使えます。

### 4. 資産データの CSV 一括ダウンロード

- **全日次データ**: 過去の全データを月ごとに並列取得し、1つのCSVファイルとして保存します。
- **指定日抽出**: 「毎月25日（給料日）」や「毎月末」など、特定の日付のデータだけを抽出してCSV保存できます。
- **高速処理**: 並列リクエストにより、10年分のデータも数十秒で取得可能です。
- **キャッシュ機能**: 過去月のデータはローカルストレージにキャッシュされ、次回以降の取得が超高速かつ低負荷になります。

### 5. 高機能なデータ表示・分析

- **資産合計推移**: 資産総額の変動を太い折れ線グラフで直感的に把握できます。
- **内訳の積み上げ表示**: オプションで「預金・現金」「株式」「投資信託」などの内訳を積み上げグラフに切り替え可能です。
- **柔軟なフィルタリング (モーダル内操作)**:
  - **期間指定**: 過去1年 / 3年 / 5年 / 10年 / 全期間
  - **特定日抽出**: グラフを見ながら「毎月〇日」の条件を自由に変更・再描画できます。
- **保存・共有**:
  - **CSV保存**: 表示中のグラフデータ（フィルタリング済み）をCSVとしてダウンロードできます。
  - **画像コピー**: グラフを画像としてクリップボードにコピーします。
  - **データコピー**: Excel貼り付け用にタブ区切りテキストとしてコピーします。

### 6. テーマカラーのカスタマイズ

- **20種類のプリセット**: 「爽やかブルー」「シックダーク」「サンセットオレンジ」「桜色」など、多彩な20種類のテーマからドロップダウンで選ぶだけで瞬時に雰囲気を変更できます。
- **カラー変更機能**: カラーピッカーでお好みの色に微調整も可能です。
- **一括貼り付け**: 4色のカラーコードをテキストエリアに貼り付けるだけで、独自のテーマを適用できます。

## 📦 インストール方法

1. このリポジトリをクローンまたはダウンロードします。
2. Google Chrome を開き、アドレスバーに `chrome://extensions/` と入力します。
3. 右上の **「デベロッパーモード」** をオンにします。
4. **「パッケージ化されていない拡張機能を読み込む」** をクリックし、このプロジェクトのフォルダ（`SRC/moneyforward_extension`）を選択します。

## 🚀 使い方

### 家計簿をソート・一括編集する場合

1. マネーフォワード ME の [家計簿画面](https://moneyforward.com/cf) にアクセスします。
2. **ソート**: 表のヘッダー（日付、内容、金額など）をクリックすると並び替わります。
3. **一括編集**:
    - 画面右下に「一括カテゴリ設定」パネルが表示されます。
    - 表の左端に追加されたチェックボックスで対象を選択します。
    - パネルで大項目・中項目を選び、「選択した項目に適用」をクリックします。

### 資産データをダウンロード・分析する場合

1. マネーフォワード ME の [資産推移画面](https://moneyforward.com/bs/history) にアクセスします。
2. 画面右下に操作パネルが表示されます。
3. **CSVダウンロード**: 「全日次データをCSV保存」などをクリックします。
4. **グラフ分析**: 「グラフを表示・生成」をクリックし、モーダル画面で分析します。

## 🛠 技術スタック・アーキテクチャ (v1.4.0+)

本拡張機能は **Native ES Modules** を採用しており、Node.js等のビルドツール（Webpack, Viteなど）を必要としません。モジュール分割を行いながら、ブラウザ標準の機能のみで動作するシンプルな構成です。

### アーキテクチャ概要

1. **Loader Pattern**:
    - `manifest.json` は `loader.js` を Content Script として読み込みます。
    - `loader.js` は `src/core/main.js` を動的インポート (`import()`) します。これにより、Content Script 内でも ES Modules が使用可能になります。
2. **Modular Design**:
    - 機能を `core` (基盤), `api` (通信), `ui` (表示), `features` (機能固有) に分割し、責務を明確化しています。

### ディレクトリ構成

```
moneyforward_extension/
├── src/
│   ├── core/
│   │   ├── main.js        # エントリーポイント。URLに応じて機能を初期化
│   │   └── config.js      # 設定、定数、テーマ管理
│   ├── api/
│   │   ├── client.js      # データ取得、CSV解析/生成のロジック
│   │   └── cache.js       # localStorageを使用したキャッシュ管理
│   ├── ui/
│   │   ├── panel.js       # 資産推移画面の操作パネルUI
│   │   └── modal.js       # 設定モーダル等の汎用UI
│   └── features/
│       ├── asset-graph.js # 資産推移グラフの描画・操作ロジック
│       ├── portfolio.js   # ポートフォリオ画面拡張（列非表示機能など）
│       └── household.js   # 家計簿の一括編集・ソート機能
├── assets/                # アイコン、ライブラリ(Chart.js)
├── loader.js              # モジュールローダー (Content Script エントリーポイント)
├── manifest.json          # 拡張機能の設定ファイル
├── style.css              # UIデザイン (テーマカスタマイズ対応)
└── README.md              # 説明書
```

## 📝 License

MIT License
